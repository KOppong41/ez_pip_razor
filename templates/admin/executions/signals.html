{% extends "admin/trading_base.html" %}
{% load static i18n admin_metrics %}

{% block title %}{% trans "Trading Signals" %} | EzTrade{% endblock %}

{% block page_title %}{% trans "Trading Signals" %}{% endblock %}

{% block page_subtitle %}{% trans "Review all incoming signals across strategies and brokers. Track signal quality, direction and status at a glance." %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .signals-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Signal-specific styles */
    .signal-direction {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
    }

    .direction-buy {
        background: var(--success-light);
        color: var(--success);
    }

    .direction-sell {
        background: var(--danger-light);
        color: var(--danger);
    }

    .direction-close {
        background: var(--warning-light);
        color: var(--warning);
    }

    /* Source badges */
    .source-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        background: rgba(67, 97, 238, 0.2);
        color: var(--primary-light);
    }

    /* Score indicators */
    .score-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 600;
    }

    .score-high {
        background: var(--success-light);
        color: var(--success);
    }

    .score-medium {
        background: var(--warning-light);
        color: var(--warning);
    }

    .score-low {
        background: var(--danger-light);
        color: var(--danger);
    }

    .score-unknown {
        background: rgba(255, 255, 255, 0.05);
        color: var(--gray-400);
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        white-space: nowrap;
    }

    .status-pending {
        background: var(--warning-light);
        color: var(--warning);
    }

    .status-consumed {
        background: var(--success-light);
        color: var(--success);
    }

    .status-rejected {
        background: var(--danger-light);
        color: var(--danger);
    }

    .status-info {
        background: rgba(67, 97, 238, 0.2);
        color: var(--primary-light);
    }

    /* Test Signal Form */
    .test-signal-form {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: var(--space-xl);
        border: 1px solid var(--border-light);
        margin-top: var(--space-lg);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-lg);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .form-label {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--gray-300);
    }

    .form-control {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        color: var(--light);
        font-size: var(--text-sm);
        transition: all 0.3s ease;
        width: 100%;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .form-text {
        font-size: var(--text-xs);
        color: var(--gray-400);
        line-height: 1.4;
    }

    .form-actions {
        display: flex;
        gap: var(--space-md);
        justify-content: flex-end;
        padding-top: var(--space-lg);
        border-top: 1px solid var(--border-light);
    }

    /* Signal metadata */
    .signal-meta {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .signal-time {
        font-size: var(--text-xs);
        color: var(--gray-300);
    }

    .signal-asset {
        font-weight: 600;
        color: var(--light);
    }

    /* Decision links */
    .decision-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        background: rgba(76, 201, 240, 0.2);
        color: var(--success);
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .decision-link:hover {
        background: rgba(76, 201, 240, 0.3);
        text-decoration: none;
        color: var(--success);
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--gray-400);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: var(--space-md);
        opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .table-container {
            overflow-x: auto;
        }

        .modern-table {
            min-width: 800px;
        }
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .header-actions {
            flex-direction: column;
            gap: var(--space-md);
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .filters-bar {
            flex-direction: column;
        }

        .filter-actions {
            flex-direction: column;
        }

        .filter-select {
            min-width: 100%;
        }
    }

    @media (max-width: 480px) {
        .test-signal-form {
            padding: var(--space-lg);
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            font-size: var(--text-xs);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="signals-container">
    <!-- Header Actions -->
    <div class="header-actions" style="margin-bottom: var(--space-xl);">
        <a href="{% url 'admin:execution_signal_add' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> {% trans "Add Signal" %}
        </a>
        <a href="{% url 'admin:execution_signal_changelist' %}" class="btn btn-outline">
            <i class="fas fa-table"></i> {% trans "Open in Admin" %}
        </a>
        <button type="button" class="btn btn-outline" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> {% trans "Refresh" %}
        </button>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" 
                   placeholder="{% trans 'Search signals by asset, source, or strategy...' %}" 
                   id="searchInput">
        </div>
        <div class="filter-actions">
            <select class="filter-select" id="statusFilter">
                <option value="">{% trans "All Status" %}</option>
                <option value="pending">{% trans "Pending" %}</option>
                <option value="consumed">{% trans "Consumed" %}</option>
                <option value="rejected">{% trans "Rejected" %}</option>
            </select>
            <select class="filter-select" id="directionFilter">
                <option value="">{% trans "All Directions" %}</option>
                <option value="buy">BUY</option>
                <option value="sell">SELL</option>
                <option value="close">CLOSE</option>
            </select>
            <select class="filter-select" id="sourceFilter">
                <option value="">{% trans "All Sources" %}</option>
                <option value="engine">Engine</option>
                <option value="manual">Manual</option>
                <option value="webhook">Webhook</option>
            </select>
            <div class="date-filter-group">
                <input type="datetime-local" id="signals-from-date" class="date-input"
                       aria-label="{% trans 'From date' %}" title="{% trans 'Filter start date' %}"
                       step="1">
                <input type="datetime-local" id="signals-to-date" class="date-input"
                       aria-label="{% trans 'To date' %}" title="{% trans 'Filter end date' %}"
                       step="1">
                <select class="filter-select" id="signals-date-sort" aria-label="{% trans 'Sort by date' %}">
                    <option value="desc">{% trans "Newest first" %}</option>
                    <option value="asc">{% trans "Oldest first" %}</option>
                </select>
            </div>
            <button class="btn btn-outline" type="button" id="clearFiltersBtn">
                <i class="fas fa-times"></i> {% trans "Clear Filters" %}
            </button>
        </div>
    </div>

    <!-- Recent Signals Card -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Recent Signals" %}</h3>
                <p class="card-subtitle">{% trans "Latest signal events entering the EzTrade decision engine" %}</p>
            </div>
            <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
                <a href="{% url 'admin:execution_decision_changelist' %}" class="btn btn-outline">
                    <i class="fas fa-brain"></i> {% trans "Decisions" %}
                </a>
                <a href="{% url 'admin:execution_order_changelist' %}" class="btn btn-outline">
                    <i class="fas fa-cart-shopping"></i> {% trans "Orders" %}
                </a>
            </div>
        </div>

        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>{% trans "Time" %}</th>
                        <th>{% trans "Asset" %}</th>
                        <th>{% trans "Direction" %}</th>
                        <th>{% trans "Source" %}</th>
                        <th>{% trans "Score" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Linked" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sig in signals %}
                        <tr class="signal-row" 
                            data-status="{{ sig.status }}"
                            data-direction="{{ sig.direction }}"
                            data-source="{{ sig.source }}"
                            data-timestamp="{{ sig.received_at|date:'c' }}"
                            data-search="{{ sig.symbol }} {{ sig.source }} {{ sig.strategy|default:'' }}">
                            <td>
                                <div class="signal-meta">
                                    <div class="signal-time">
                                        {{ sig.received_at|date:"M j, H:i" }}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="signal-asset">
                                    {{ sig.symbol }}
                                </div>
                            </td>
                            <td>
                                {% if sig.direction == "buy" %}
                                    <span class="signal-direction direction-buy">
                                        <i class="fas fa-arrow-up"></i>BUY
                                    </span>
                                {% elif sig.direction == "sell" %}
                                    <span class="signal-direction direction-sell">
                                        <i class="fas fa-arrow-down"></i>SELL
                                    </span>
                                {% else %}
                                    <span class="signal-direction direction-close">
                                        <i class="fas fa-times"></i>CLOSE
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="source-badge">
                                    <i class="fas fa-{{ sig.source|lower }}"></i>
                                    {{ sig.source }}
                                </span>
                            </td>
                            <td>
                                {% if sig.score %}
                                    {% if sig.score >= 0.7 %}
                                        <span class="score-indicator score-high">
                                            <i class="fas fa-gauge-high"></i>{{ sig.score|floatformat:2 }}
                                        </span>
                                    {% elif sig.score >= 0.4 %}
                                        <span class="score-indicator score-medium">
                                            <i class="fas fa-gauge-med"></i>{{ sig.score|floatformat:2 }}
                                        </span>
                                    {% else %}
                                        <span class="score-indicator score-low">
                                            <i class="fas fa-gauge-low"></i>{{ sig.score|floatformat:2 }}
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="score-indicator score-unknown">
                                        <i class="fas fa-question"></i>-
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if sig.status == "pending" %}
                                    <span class="status-badge status-pending">
                                        <i class="fas fa-clock"></i>{% trans "Pending" %}
                                    </span>
                                {% elif sig.status == "consumed" %}
                                    <span class="status-badge status-consumed">
                                        <i class="fas fa-check"></i>{% trans "Consumed" %}
                                    </span>
                                {% else %}
                                    <span class="status-badge status-rejected">
                                        <i class="fas fa-times"></i>{% trans "Rejected" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if sig.decisions.count %}
                                    <a href="{% url 'admin:execution_decision_changelist' %}?signal__id__exact={{ sig.pk }}" 
                                       class="decision-link">
                                        <i class="fas fa-link"></i>
                                        {{ sig.decisions.count }} {% trans "decision(s)" %}
                                    </a>
                                {% else %}
                                    <span style="font-size: var(--text-xs); color: var(--gray-400);">
                                        {% trans "No decisions" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'admin:execution_signal_change' sig.pk %}"
                                       class="action-btn inspect"
                                       title="{% trans 'View / Edit signal' %}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'admin:execution_decision_changelist' %}?signal__id__exact={{ sig.pk }}"
                                       class="action-btn link"
                                       title="{% trans 'View decisions' %}">
                                        <i class="fas fa-balance-scale"></i>
                                    </a>
                                    {% if not sig.decisions.count %}
                                        <a href="{% url 'admin:execution_signal_delete' sig.pk %}"
                                           class="action-btn delete"
                                           title="{% trans 'Delete signal' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="empty-state">
                                <i class="fas fa-wave-square empty-state-icon"></i>
                                <div>{% trans "No signals found." %}</div>
                                <div style="font-size: var(--text-sm); margin-top: var(--space-sm);">
                                    {% trans "Signals will appear here when they are generated by your trading strategies." %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <div class="pagination-info">
                {{ signals|length }} {% trans "signals shown" %}
            </div>
            <div class="pagination-controls">
                <a href="{% url 'admin:execution_signal_changelist' %}" class="pagination-btn">
                    {% trans "Open in Admin" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Test Signal Injection Form -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Inject Test Signal" %}</h3>
                <p class="card-subtitle">{% trans "Quickly push a manual signal into the engine for testing" %}</p>
            </div>
        </div>
        
        <form class="test-signal-form" method="post" action="{% url 'admin:execution_signal_add' %}">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">{% trans "Asset Symbol" %} *</label>
                    <input type="text" class="form-control" name="symbol" placeholder="e.g. EUR/USD" required>
                    <div class="form-text">{% trans "Symbol/ticker as configured on the broker" %}</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">{% trans "Direction" %} *</label>
                    <select class="form-control" name="direction" required>
                        <option value="buy">BUY</option>
                        <option value="sell">SELL</option>
                        <option value="close">CLOSE</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">{% trans "Source" %} *</label>
                    <select class="form-control" name="source" required>
                        <option value="manual">Manual</option>
                        <option value="engine">Engine</option>
                        <option value="webhook">Webhook</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">{% trans "Score (0–1)" %}</label>
                    <input type="number" step="0.01" min="0" max="1" class="form-control" name="score" placeholder="0.75">
                    <div class="form-text">{% trans "Optional strength/confidence of the signal" %}</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">{% trans "Strategy" %}</label>
                    <input type="text" class="form-control" name="strategy" placeholder="e.g. RSI_Overbought">
                    <div class="form-text">{% trans "Strategy name that generated this signal" %}</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">{% trans "Route to Bot (optional)" %}</label>
                    <input type="text" class="form-control" name="bot_id" placeholder="{% trans 'Bot ID or tag' %}">
                    <div class="form-text">{% trans "Leave empty to let routing rules decide" %}</div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">{% trans "Extra Payload / Note" %}</label>
                <textarea class="form-control" name="payload" rows="3" placeholder="{% trans 'Any additional JSON/meta or comments' %}"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="cancelTestBtn">{% trans "Cancel" %}</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-paper-plane"></i> {% trans "Send Test Signal" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const directionFilter = document.getElementById('directionFilter');
    const sourceFilter = document.getElementById('sourceFilter');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const cancelTestBtn = document.getElementById('cancelTestBtn');
    const fromDateInput = document.getElementById('signals-from-date');
    const toDateInput = document.getElementById('signals-to-date');
    const dateSortSelect = document.getElementById('signals-date-sort');
    const paginationInfo = document.querySelector('.pagination-info');
    const tableBody = document.querySelector('.modern-table tbody');

    const getRows = () => Array.from(document.querySelectorAll('.signal-row'));

    const parseRowDate = (row) => {
        const timestamp = row.dataset.timestamp;
        return timestamp ? new Date(timestamp) : null;
    };

    const sortRows = () => {
        if (!tableBody || !dateSortSelect) {
            return;
        }

        const order = dateSortSelect.value || 'desc';
        const sortedRows = getRows().sort((a, b) => {
            const dateA = parseRowDate(a) || new Date(0);
            const dateB = parseRowDate(b) || new Date(0);
            return order === 'asc' ? dateA - dateB : dateB - dateA;
        });

        sortedRows.forEach(row => tableBody.appendChild(row));
    };

    const filterSignals = () => {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const statusValue = statusFilter ? statusFilter.value : '';
        const directionValue = directionFilter ? directionFilter.value : '';
        const sourceValue = sourceFilter ? sourceFilter.value : '';
        const fromDate = fromDateInput && fromDateInput.value ? new Date(fromDateInput.value) : null;
        const toDate = toDateInput && toDateInput.value ? new Date(toDateInput.value) : null;

        let visibleCount = 0;

        getRows().forEach(row => {
            const searchData = row.getAttribute('data-search').toLowerCase();
            const statusData = row.getAttribute('data-status');
            const directionData = row.getAttribute('data-direction');
            const sourceData = row.getAttribute('data-source');
            const rowDate = parseRowDate(row);

            const matchesSearch = searchData.includes(searchTerm);
            const matchesStatus = !statusValue || statusData === statusValue;
            const matchesDirection = !directionValue || directionData === directionValue;
            const matchesSource = !sourceValue || sourceData === sourceValue;

            let matchesDate = true;
            if (matchesDate && fromDate && rowDate) {
                matchesDate = rowDate >= fromDate;
            }
            if (matchesDate && toDate && rowDate) {
                matchesDate = rowDate <= toDate;
            }

            if (matchesSearch && matchesStatus && matchesDirection && matchesSource && matchesDate) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        if (paginationInfo) {
            paginationInfo.textContent = `${visibleCount} {% trans "signals shown" %}`;
        }
    };

    // Event listeners for filters
    if (searchInput) {
        searchInput.addEventListener('input', filterSignals);
    }

    if (statusFilter) {
        statusFilter.addEventListener('change', filterSignals);
    }

    if (directionFilter) {
        directionFilter.addEventListener('change', filterSignals);
    }

    if (sourceFilter) {
        sourceFilter.addEventListener('change', filterSignals);
    }

    if (fromDateInput) {
        fromDateInput.addEventListener('change', filterSignals);
    }

    if (toDateInput) {
        toDateInput.addEventListener('change', filterSignals);
    }

    if (dateSortSelect) {
        dateSortSelect.addEventListener('change', () => {
            sortRows();
            filterSignals();
        });
    }

    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        statusFilter.value = '';
        directionFilter.value = '';
        sourceFilter.value = '';
        if (fromDateInput) {
            fromDateInput.value = '';
        }
        if (toDateInput) {
            toDateInput.value = '';
        }
        if (dateSortSelect) {
            dateSortSelect.value = 'desc';
            sortRows();
        }
        filterSignals();
    });

    // Refresh button
    refreshBtn.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Refreshing..." %}';
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });

    // Cancel test form
    cancelTestBtn.addEventListener('click', function() {
        const form = this.closest('form');
        form.reset();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Focus search on Ctrl+K or /
        if ((e.ctrlKey && e.key === 'k') || e.key === '/') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Refresh on F5
        if (e.key === 'F5') {
            e.preventDefault();
            refreshBtn.click();
        }
        
        // New signal on Ctrl+N
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            document.querySelector('a[href*="execution_signal_add"]').click();
        }
    });

    // Auto-refresh every 30 seconds (optional)
    setInterval(() => {
        if (!document.hidden) {
            refreshBtn.click();
        }
    }, 30000);

    sortRows();
    filterSignals();
});
</script>
{% endblock %}
