{% extends "admin/trading_base.html" %}
{% load static i18n admin_metrics %}

{% block title %}{% trans "Execution Settings" %} | EzTrade{% endblock %}

{% block page_title %}{% trans "Execution Settings" %}{% endblock %}

{% block page_subtitle %}{% trans "Configure global execution parameters, risk limits, and trading guardrails." %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .execution-settings-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Settings-specific styles */
    .setting-key {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-sm);
        font-weight: 600;
        background: rgba(67, 97, 238, 0.2);
        color: var(--primary-light);
        font-family: 'Courier New', monospace;
    }

    .setting-icon {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: var(--text-sm);
        font-weight: 600;
    }

    .setting-meta {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .setting-name {
        font-weight: 600;
        color: var(--light);
    }

    .setting-description {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    /* Parameter values */
    .param-value {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .value-display {
        font-weight: 600;
        color: var(--light);
        font-size: var(--text-sm);
    }

    .value-label {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    /* Boolean indicators */
    .bool-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        white-space: nowrap;
    }

    .bool-true {
        background: var(--success-light);
        color: var(--success);
    }

    .bool-false {
        background: var(--danger-light);
        color: var(--danger);
    }

    /* Numeric value styling */
    .numeric-value {
        font-weight: 600;
        color: var(--light);
    }

    .numeric-positive {
        color: var(--success);
    }

    .numeric-warning {
        color: var(--warning);
    }

    .numeric-danger {
        color: var(--danger);
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: flex-start;
        flex-wrap: nowrap;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
        border-radius: 4px;
        font-size: 11px;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid var(--border-light);
        background: rgba(255, 255, 255, 0.05);
        color: var(--gray-300);
        flex-shrink: 0;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
        text-decoration: none;
        transform: translateY(-1px);
    }

    .action-btn.edit {
        background: var(--primary-light);
        color: white;
        border-color: var(--primary);
    }

    .action-btn.view {
        background: rgba(148, 163, 184, 0.2);
        color: var(--gray-400);
        border-color: var(--gray-400);
    }

    .action-btn.reset {
        background: var(--warning-light);
        color: var(--warning);
        border-color: var(--warning);
    }

    /* Category badges */
    .category-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        white-space: nowrap;
    }

    .category-decision {
        background: rgba(76, 201, 240, 0.2);
        color: var(--info);
    }

    .category-risk {
        background: rgba(248, 150, 30, 0.2);
        color: var(--warning);
    }

    .category-account {
        background: rgba(67, 97, 238, 0.2);
        color: var(--primary-light);
    }

    .category-scalp {
        background: rgba(247, 37, 133, 0.2);
        color: var(--danger);
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--gray-400);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: var(--space-md);
        opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .table-container {
            overflow-x: auto;
        }

        .modern-table {
            min-width: 800px;
        }
    }

    @media (max-width: 768px) {
        .header-actions {
            flex-direction: column;
            gap: var(--space-md);
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .filters-bar {
            flex-direction: column;
        }

        .filter-actions {
            flex-direction: column;
        }

        .filter-select {
            min-width: 100%;
        }

        .action-buttons {
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .action-buttons {
            flex-direction: row;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            font-size: 10px;
        }
    }

    .danger-card {
        border: 1px solid rgba(239, 68, 68, 0.35);
        box-shadow: 0 20px 45px rgba(239, 68, 68, 0.18);
    }

    .maintenance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: var(--space-md);
        margin-top: var(--space-lg);
    }

    .maintenance-card {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px;
        padding: var(--space-lg);
        background: rgba(239, 68, 68, 0.07);
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }

    .maintenance-card h4 {
        margin: 0;
        font-size: var(--text-md);
        color: #f87171;
    }

    .maintenance-count {
        font-size: var(--text-sm);
        color: rgba(255,255,255,0.7);
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        padding: var(--space-lg);
    }

    .modal-overlay.is-visible {
        display: flex;
    }

    .modal-panel {
        background: var(--surface);
        border-radius: 18px;
        max-width: 520px;
        width: 100%;
        padding: var(--space-xl);
        box-shadow: 0 25px 65px rgba(0,0,0,0.35);
        animation: fadeInUp 0.25s ease;
    }

    .modal-warning {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.4);
        border-radius: 8px;
        padding: var(--space-sm);
        font-size: var(--text-sm);
        margin-bottom: var(--space-lg);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-md);
        margin-top: var(--space-lg);
    }

    #clearConfirmInput {
        width: 100%;
        padding: var(--space-sm);
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.2);
        color: inherit;
        font-size: var(--text-md);
    }
</style>
{% endblock %}

{% block content %}
<div class="execution-settings-container">
    <!-- Header Actions -->
    <div class="header-actions" style="margin-bottom: var(--space-xl);">
        <a href="{% url 'admin:execution_executionsetting_add' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> {% trans "Add Setting" %}
        </a>
        {% if scalper_symbols_url %}
        <a href="{{ scalper_symbols_url }}" class="btn btn-secondary">
            <i class="fas fa-chart-line"></i> {% trans "Asset Profiles" %}
        </a>
        {% endif %}
        <button type="button" class="btn btn-warning" id="resetDefaultsBtn">
            <i class="fas fa-undo"></i> {% trans "Reset to Defaults" %}
        </button>
        <button type="button" class="btn btn-outline" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> {% trans "Refresh" %}
        </button>
    </div>

    {% if clear_actions %}
    <div class="card danger-card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Maintenance & Cache Controls" %}</h3>
                <p class="card-subtitle">{% trans "Danger zone: permanently clear runtime caches and execution logs." %}</p>
            </div>
        </div>
        <div class="maintenance-grid">
            {% for action in clear_actions %}
            <div class="maintenance-card">
                <div>
                    <h4>{{ action.label }}</h4>
                    <div class="maintenance-count">
                        {{ action.count }} {% trans "entries" %}
                    </div>
                </div>
                <button type="button"
                        class="btn btn-danger clear-log-btn"
                        data-clear-url="{{ action.url }}"
                        data-clear-label="{{ action.label }}">
                    <i class="fas fa-trash-alt"></i>
                    {% trans "Clear" %}
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" 
                   placeholder="{% trans 'Search settings by key or description...' %}" 
                   id="searchInput">
        </div>
        <div class="filter-actions">
            <select class="filter-select" id="categoryFilter">
                <option value="">{% trans "All Categories" %}</option>
                <option value="decision">{% trans "Decision Guardrails" %}</option>
                <option value="scalp">{% trans "Scalp Tuning" %}</option>
                <option value="risk">{% trans "Risk & Monitoring" %}</option>
                <option value="account">{% trans "Accounts & Sizing" %}</option>
            </select>
            <button class="btn btn-outline" type="button" id="clearFiltersBtn">
                <i class="fas fa-times"></i> {% trans "Clear Filters" %}
            </button>
        </div>
    </div>

    <!-- Execution Settings Card -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Execution Settings" %}</h3>
                <p class="card-subtitle">{% trans "Global execution parameters and trading configuration" %}</p>
            </div>
            <div class="action-icons">
                <i class="fas fa-download" title="{% trans 'Export' %}"></i>
                <i class="fas fa-upload" title="{% trans 'Import' %}"></i>
                <i class="fas fa-cog" title="{% trans 'Settings' %}"></i>
            </div>
        </div>

        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>{% trans "Setting" %}</th>
                        <th>{% trans "Decision Parameters" %}</th>
                        <th>{% trans "Risk Parameters" %}</th>
                        <th>{% trans "Category" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for setting in settings %}
                        <tr class="setting-row" 
                            data-category="{{ setting.get_category|default:'decision' }}"
                            data-search="{{ setting.key }} {{ setting.get_description|default:'' }}">
                            <td>
                                <div style="display: flex; align-items: center; gap: var(--space-md);">
                                    <div class="setting-icon">
                                        <i class="fas fa-sliders-h"></i>
                                    </div>
                                    <div class="setting-meta">
                                        <div class="setting-name">
                                            <span class="setting-key">
                                                {{ setting.key }}
                                            </span>
                                        </div>
                                        <div class="setting-description">
                                            {{ setting.get_description|default:"Global execution setting" }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                                    <div class="param-value">
                                        <div class="value-display">
                                            Min Score: <span class="numeric-value">{{ setting.decision_min_score|default:"0.00" }}</span>
                                        </div>
                                        <div class="value-label">{% trans "Minimum decision score" %}</div>
                                    </div>
                                    <div class="param-value">
                                        <div class="value-display">
                                            Flip Score: <span class="numeric-value">{{ setting.decision_flip_score|default:"0.00" }}</span>
                                        </div>
                                        <div class="value-label">{% trans "Decision flip threshold" %}</div>
                                    </div>
                                    <div class="param-value">
                                        <div class="value-display">
                                            {% if setting.decision_allow_hedging %}
                                                <span class="bool-indicator bool-true">
                                                    <i class="fas fa-check"></i>{% trans "Hedging Allowed" %}
                                                </span>
                                            {% else %}
                                                <span class="bool-indicator bool-false">
                                                    <i class="fas fa-times"></i>{% trans "No Hedging" %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                                    <div class="param-value">
                                        <div class="value-display">
                                            Timeout: <span class="numeric-value">{{ setting.order_ack_timeout_seconds|default:"0" }}s</span>
                                        </div>
                                        <div class="value-label">{% trans "Order acknowledgment timeout" %}</div>
                                    </div>
                                    <div class="param-value">
                                        <div class="value-display">
                                            Max Lot: <span class="numeric-value">{{ setting.max_order_lot|default:"0.00" }}</span>
                                        </div>
                                        <div class="value-label">{% trans "Maximum order lot size" %}</div>
                                    </div>
                                    <div class="param-value">
                                        <div class="value-display">
                                            Notional: <span class="numeric-value">${{ setting.max_order_notional|default:"0.00" }}</span>
                                        </div>
                                        <div class="value-label">{% trans "Maximum order notional" %}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% with category=setting.get_category %}
                                    {% if category == "decision" %}
                                        <span class="category-badge category-decision">
                                            <i class="fas fa-brain"></i>{% trans "Decision" %}
                                        </span>
                                    {% elif category == "scalp" %}
                                        <span class="category-badge category-scalp">
                                            <i class="fas fa-bolt"></i>{% trans "Scalp" %}
                                        </span>
                                    {% elif category == "risk" %}
                                        <span class="category-badge category-risk">
                                            <i class="fas fa-shield-alt"></i>{% trans "Risk" %}
                                        </span>
                                    {% else %}
                                        <span class="category-badge category-account">
                                            <i class="fas fa-wallet"></i>{% trans "Account" %}
                                        </span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'admin:execution_executionsetting_change' setting.pk %}"
                                       class="action-btn edit"
                                       title="{% trans 'Edit setting' %}">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'admin:execution_executionsetting_change' setting.pk %}"
                                       class="action-btn view"
                                       title="{% trans 'View details' %}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" 
                                            class="action-btn reset"
                                            data-setting-id="{{ setting.pk }}"
                                            title="{% trans 'Reset to default' %}">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="fas fa-cogs empty-state-icon"></i>
                                <div>{% trans "No execution settings configured." %}</div>
                                <div style="font-size: var(--text-sm); margin-top: var(--space-sm);">
                                    {% trans "Create your first execution setting to configure global trading parameters." %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <div class="pagination-info">
                {{ settings|length }} {% trans "settings shown" %}
            </div>
            <div class="pagination-controls">
                <a href="{% url 'admin:execution_executionsetting_changelist' %}" class="pagination-btn">
                    {% trans "Open in Admin" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Stats Card -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Settings Overview" %}</h3>
                <p class="card-subtitle">{% trans "Execution settings summary and configuration status" %}</p>
            </div>
        </div>
        
        <div class="progress-grid">
            <div class="progress-card">
                <div class="progress-value">{{ total_settings_count|default:0 }}</div>
                <div class="progress-label">{% trans "Total Settings" %}</div>
            </div>
            <div class="progress-card">
                <div class="progress-value">{{ decision_settings_count|default:0 }}</div>
                <div class="progress-label">{% trans "Decision" %}</div>
            </div>
            <div class="progress-card">
                <div class="progress-value">{{ risk_settings_count|default:0 }}</div>
                <div class="progress-label">{% trans "Risk" %}</div>
            </div>
            <div class="progress-card">
                <div class="progress-value">{{ account_settings_count|default:0 }}</div>
                <div class="progress-label">{% trans "Account" %}</div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="clearLogModal">
    <div class="modal-panel">
        <h3>{% trans "Confirm Deletion" %}</h3>
        <div class="modal-warning">
            <strong>{% trans "Warning" %}:</strong>
            {% trans "This action cannot be undone and will permanently remove all records for the selected log." %}
        </div>
        <p>
            {% trans "Please type the text below to confirm:" %} <strong id="clearLogLabel"></strong>
        </p>
        <form method="post" id="clearLogForm">
            {% csrf_token %}
            <input type="text" name="confirm_input" id="clearConfirmInput" autocomplete="off" required>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" id="clearCancelBtn">
                    {% trans "Cancel" %}
                </button>
                <button type="submit" class="btn btn-danger" id="clearConfirmBtn" disabled>
                    {% trans "Delete" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const resetDefaultsBtn = document.getElementById('resetDefaultsBtn');
    const paginationInfo = document.querySelector('.pagination-info');
    const clearButtons = document.querySelectorAll('.clear-log-btn');
    const clearModal = document.getElementById('clearLogModal');
    const clearForm = document.getElementById('clearLogForm');
    const clearLabelEl = document.getElementById('clearLogLabel');
    const clearInput = document.getElementById('clearConfirmInput');
    const clearConfirmBtn = document.getElementById('clearConfirmBtn');
    const clearCancelBtn = document.getElementById('clearCancelBtn');
    let requiredText = "";

    const getRows = () => Array.from(document.querySelectorAll('.setting-row'));

    const filterSettings = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;

        let visibleCount = 0;

        getRows().forEach(row => {
            const searchData = row.getAttribute('data-search').toLowerCase();
            const categoryData = row.getAttribute('data-category');

            const matchesSearch = searchData.includes(searchTerm);
            const matchesCategory = !categoryValue || categoryData === categoryValue;

            if (matchesSearch && matchesCategory) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        if (paginationInfo) {
            paginationInfo.textContent = `${visibleCount} {% trans "settings shown" %}`;
        }
    };

    // Event listeners for filters
    searchInput.addEventListener('input', filterSettings);
    categoryFilter.addEventListener('change', filterSettings);

    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        categoryFilter.value = '';
        filterSettings();
    });

    // Refresh button
    refreshBtn.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Refreshing..." %}';
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });

    // Reset to defaults
    resetDefaultsBtn.addEventListener('click', function() {
        if (confirm('{% trans "Are you sure you want to reset all settings to their default values? This action cannot be undone." %}')) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Resetting..." %}';
            // In real implementation, this would make API calls
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-undo"></i> {% trans "Reset to Defaults" %}';
                alert('{% trans "All settings have been reset to their default values." %}');
                window.location.reload();
            }, 2000);
        }
    });

    // Individual setting reset
    document.querySelectorAll('.action-btn.reset').forEach(btn => {
        btn.addEventListener('click', function() {
            const settingId = this.dataset.settingId;
            if (confirm('{% trans "Are you sure you want to reset this setting to its default value?" %}')) {
                // In real implementation, this would make an API call
                alert(`{% trans "Setting" %} ${settingId} {% trans "has been reset to default." %}`);
            }
        });
    });

    if (clearModal && clearButtons.length) {
        const closeClearModal = () => clearModal.classList.remove('is-visible');

        clearButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                requiredText = btn.dataset.clearLabel;
                clearLabelEl.textContent = requiredText;
                clearForm.action = btn.dataset.clearUrl;
                clearInput.value = "";
                clearConfirmBtn.textContent = '{% trans "Delete" %} ' + btn.dataset.clearLabel;
                clearConfirmBtn.disabled = true;
                clearModal.classList.add('is-visible');
                setTimeout(() => clearInput.focus(), 50);
            });
        });

        clearCancelBtn.addEventListener('click', closeClearModal);
        clearModal.addEventListener('click', (event) => {
            if (event.target === clearModal) {
                closeClearModal();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && clearModal.classList.contains('is-visible')) {
                closeClearModal();
            }
        });
        clearInput.addEventListener('input', () => {
            clearConfirmBtn.disabled = clearInput.value.trim() !== requiredText;
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Focus search on Ctrl+K or /
        if ((e.ctrlKey && e.key === 'k') || e.key === '/') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Refresh on F5
        if (e.key === 'F5') {
            e.preventDefault();
            refreshBtn.click();
        }
        
        // New setting on Ctrl+N
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            document.querySelector('a[href*="execution_executionsetting_add"]').click();
        }
    });

    // Auto-refresh every 60 seconds (optional)
    setInterval(() => {
        if (!document.hidden) {
            refreshBtn.click();
        }
    }, 60000);

    filterSettings();
});
</script>
{% endblock %}
