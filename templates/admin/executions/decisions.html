{% extends "admin/trading_base.html" %}
{% load static i18n admin_metrics %}

{% block title %}{% trans "Decision Engine" %} | EzTrade{% endblock %}

{% block page_title %}{% trans "Decision Engine" %}{% endblock %}

{% block page_subtitle %}{% trans "Full audit trail of how signals are evaluated. See why a trade was accepted, rejected, or skipped based on your risk rules." %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .decisions-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Filters Bar */
    .filters-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-md);
        padding: var(--space-lg);
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-light);
        margin-bottom: var(--space-lg);
        flex-wrap: wrap;
    }

    .search-box {
        position: relative;
        flex: 1;
        min-width: 300px;
    }

    .search-input {
        width: 100%;
        padding: var(--space-md) var(--space-md) var(--space-md) var(--space-2xl);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        color: var(--light);
        font-size: var(--text-sm);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .search-icon {
        position: absolute;
        left: var(--space-md);
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-500);
        font-size: var(--text-sm);
    }

    .filter-actions {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        flex-wrap: wrap;
    }

    .filter-select {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        color: var(--light);
        font-size: var(--text-sm);
        min-width: 150px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
    }

    /* Status Badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        white-space: nowrap;
    }

    .status-accepted {
        background: var(--success-light);
        color: var(--success);
    }

    .status-rejected {
        background: var(--danger-light);
        color: var(--danger);
    }

    .status-skipped {
        background: var(--warning-light);
        color: var(--warning);
    }

    /* Pills for symbols and scores */
    .pill {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        white-space: nowrap;
    }

    .pill-symbol {
        background: rgba(67, 97, 238, 0.2);
        color: var(--primary-light);
    }

    .pill-score-high {
        background: var(--success-light);
        color: var(--success);
    }

    .pill-score-low {
        background: var(--danger-light);
        color: var(--danger);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: var(--space-xs);
        justify-content: flex-end;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        color: var(--gray-400);
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: var(--text-sm);
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--light);
        text-decoration: none;
        transform: translateY(-1px);
    }

    .action-btn.inspect:hover {
        background: var(--primary-light);
        color: white;
        border-color: var(--primary);
    }

    .action-btn.link:hover {
        background: var(--success-light);
        color: var(--success);
        border-color: var(--success);
    }

    /* Signal Info */
    .signal-info {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .signal-id {
        font-weight: 500;
        color: var(--light);
    }

    .signal-meta {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    /* Reason Text */
    .reason-text {
        font-size: var(--text-xs);
        color: var(--gray-300);
        line-height: 1.4;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .reason-text.expanded {
        white-space: normal;
        overflow: visible;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-md) var(--space-lg);
        border-top: 1px solid var(--border-light);
        font-size: var(--text-sm);
        color: var(--gray-400);
        flex-wrap: wrap;
        gap: var(--space-md);
    }

    .pagination-info {
        font-weight: 500;
    }

    .pagination-controls {
        display: flex;
        gap: var(--space-sm);
    }

    .pagination-btn {
        padding: var(--space-sm) var(--space-md);
        background: var(--primary);
        color: white;
        border-radius: var(--radius-md);
        text-decoration: none;
        font-size: var(--text-sm);
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .pagination-btn:hover {
        background: var(--primary-light);
        text-decoration: none;
        color: white;
        transform: translateY(-1px);
    }

    /* Kill Switch */
    .kill-switch-btn {
        background: var(--danger);
        color: white;
        border: none;
        padding: var(--space-md) var(--space-lg);
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .kill-switch-btn:hover {
        background: #e11d74;
        transform: translateY(-1px);
    }

    .kill-switch-btn.active {
        background: var(--success);
    }

    .kill-switch-btn.active:hover {
        background: #3aa8d4;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .filters-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            min-width: 100%;
        }

        .filter-actions {
            justify-content: space-between;
            width: 100%;
        }
    }

    @media (max-width: 768px) {
        .table-container {
            overflow-x: auto;
        }

        .modern-table {
            min-width: 800px;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            font-size: var(--text-xs);
        }

        .pagination {
            flex-direction: column;
            text-align: center;
        }

        .header-actions {
            flex-direction: column;
            gap: var(--space-md);
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .filter-actions {
            flex-direction: column;
        }

        .filter-select {
            min-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="decisions-container">
    <!-- Header Actions -->
    <div class="header-actions" style="margin-bottom: var(--space-xl);">
        <a href="{% url 'admin:execution_decision_changelist' %}" class="btn btn-outline">
            <i class="fas fa-table"></i> {% trans "Open in Admin" %}
        </a>
        <button type="button" class="kill-switch-btn" id="killSwitchBtn">
            <i class="fas fa-power-off"></i> {% trans "Global Kill Switch" %}
        </button>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" 
                   placeholder="{% trans 'Search by asset, reason, or signal ID...' %}" 
                   id="searchInput">
        </div>
        <div class="filter-actions">
            <select class="filter-select" id="outcomeFilter">
                <option value="">{% trans "All Outcomes" %}</option>
                <option value="accepted">{% trans "Accepted" %}</option>
                <option value="rejected">{% trans "Rejected" %}</option>
                <option value="skipped">{% trans "Skipped" %}</option>
            </select>
            <select class="filter-select" id="directionFilter">
                <option value="">{% trans "All Directions" %}</option>
                <option value="BUY">BUY</option>
                <option value="SELL">SELL</option>
                <option value="CLOSE">CLOSE</option>
            </select>
            <div class="date-filter-group">
                <input type="datetime-local" id="decisions-from-date" class="date-input"
                       aria-label="{% trans 'From date' %}" title="{% trans 'Filter start date' %}"
                       step="1">
                <input type="datetime-local" id="decisions-to-date" class="date-input"
                       aria-label="{% trans 'To date' %}" title="{% trans 'Filter end date' %}"
                       step="1">
                <select class="filter-select" id="decisions-date-sort" aria-label="{% trans 'Sort by date' %}">
                    <option value="desc">{% trans "Newest first" %}</option>
                    <option value="asc">{% trans "Oldest first" %}</option>
                </select>
            </div>
            <button class="btn btn-outline" type="button" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> {% trans "Refresh" %}
            </button>
        </div>
    </div>

    <!-- Recent Decisions Card -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Recent Decisions" %}</h3>
                <p class="card-subtitle">
                    {% trans "Each row links signal → decision. Use the admin view for full details and related orders." %}
                </p>
            </div>
            <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
                <a href="{% url 'admin:execution_signal_changelist' %}" class="btn btn-outline">
                    <i class="fas fa-wave-square"></i> {% trans "View Signals" %}
                </a>
                <a href="{% url 'admin:execution_order_changelist' %}" class="btn btn-outline">
                    <i class="fas fa-cart-shopping"></i> {% trans "View Orders" %}
                </a>
            </div>
        </div>

        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>{% trans "Time" %}</th>
                        <th>{% trans "Signal" %}</th>
                        <th>{% trans "Asset" %}</th>
                        <th>{% trans "Decision" %}</th>
                        <th>{% trans "Score" %}</th>
                        <th>{% trans "Reason" %}</th>
                        <th>{% trans "Inspector" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dec in decisions %}
                        <tr class="decision-row" 
                            data-outcome="{{ dec.action }}" 
                            data-direction="{{ dec.signal.direction|upper }}"
                            data-search="{{ dec.signal.symbol }} {{ dec.signal.id }} {{ dec.reason }}"
                            data-timestamp="{{ dec.decided_at|date:'c' }}">
                            <td>
                                <span style="font-size: var(--text-xs); color: var(--gray-300);">
                                    {{ dec.decided_at|date:"M j, H:i" }}
                                </span>
                            </td>
                            <td>
                                <div class="signal-info">
                                    <div class="signal-id">
                                        {{ dec.signal.id|default:"-" }}
                                    </div>
                                    <div class="signal-meta">
                                        {% if dec.signal.bot %}
                                            {{ dec.signal.bot.name }} · {{ dec.signal.source }}
                                        {% else %}
                                            {{ dec.signal.source }}
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="pill pill-symbol">
                                    {% if dec.signal.direction == "buy" %}
                                        <i class="fas fa-arrow-up"></i>
                                    {% else %}
                                        <i class="fas fa-arrow-down"></i>
                                    {% endif %}
                                    {{ dec.signal.symbol }} · {{ dec.signal.direction|upper }}
                                </span>
                            </td>
                            <td>
                                {% if dec.action == "open" %}
                                    <span class="status-badge status-accepted">
                                        <i class="fas fa-check"></i>
                                        {% trans "Open" %}
                                    </span>
                                {% elif dec.action == "close" %}
                                    <span class="status-badge status-skipped">
                                        <i class="fas fa-pause"></i>
                                        {% trans "Close" %}
                                    </span>
                                {% else %}
                                    <span class="status-badge status-rejected">
                                        <i class="fas fa-times"></i>
                                        {% trans "Ignore" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dec.score >= 0.5 %}
                                    <span class="pill pill-score-high">
                                        <i class="fas fa-gauge-high"></i>{{ dec.score|floatformat:2 }}
                                    </span>
                                {% else %}
                                    <span class="pill pill-score-low">
                                        <i class="fas fa-gauge-low"></i>{{ dec.score|floatformat:2 }}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="reason-text" title="{{ dec.reason|default:_('No reason recorded') }}">
                                    {{ dec.reason|default:_("No reason recorded")|truncatechars:50 }}
                                </span>
                            </td>
                            <td>
                                <span style="font-size: var(--text-xs); color: var(--gray-400);">
                                    {{ dec.params|default:"-" }}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'admin:execution_decision_change' dec.pk %}"
                                       class="action-btn inspect"
                                       title="{% trans 'View / Edit decision' %}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if dec.signal_id %}
                                        <a href="{% url 'admin:execution_signal_change' dec.signal_id %}"
                                           class="action-btn link"
                                           title="{% trans 'Open related signal' %}">
                                            <i class="fas fa-link"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" style="text-align: center; color: var(--gray-400); padding: var(--space-xl);">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: var(--space-md); display: block;"></i>
                                {% trans "No decisions found." %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <div class="pagination-info">
                {{ decisions|length }} {% trans "decision(s) shown" %}
            </div>
            <div class="pagination-controls">
                <a href="{% url 'admin:execution_decision_changelist' %}" class="pagination-btn">
                    {% trans "Open in Admin" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const searchInput = document.getElementById('searchInput');
    const outcomeFilter = document.getElementById('outcomeFilter');
    const directionFilter = document.getElementById('directionFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const killSwitchBtn = document.getElementById('killSwitchBtn');
    const fromDateInput = document.getElementById('decisions-from-date');
    const toDateInput = document.getElementById('decisions-to-date');
    const dateSortSelect = document.getElementById('decisions-date-sort');
    const paginationInfo = document.querySelector('.pagination-info');
    const tableBody = document.querySelector('.modern-table tbody');

    const getRows = () => Array.from(document.querySelectorAll('.decision-row'));

    const parseRowDate = (row) => {
        const timestamp = row.dataset.timestamp;
        return timestamp ? new Date(timestamp) : null;
    };

    const sortRows = () => {
        if (!tableBody || !dateSortSelect) {
            return;
        }

        const order = dateSortSelect.value || 'desc';
        const sortedRows = getRows().sort((a, b) => {
            const dateA = parseRowDate(a) || new Date(0);
            const dateB = parseRowDate(b) || new Date(0);
            return order === 'asc' ? dateA - dateB : dateB - dateA;
        });

        sortedRows.forEach(row => tableBody.appendChild(row));
    };

    const filterDecisions = () => {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const outcomeValue = outcomeFilter ? outcomeFilter.value : '';
        const directionValue = directionFilter ? directionFilter.value : '';
        const fromDate = fromDateInput && fromDateInput.value ? new Date(fromDateInput.value) : null;
        const toDate = toDateInput && toDateInput.value ? new Date(toDateInput.value) : null;

        let visibleCount = 0;

        getRows().forEach(row => {
            const searchData = row.getAttribute('data-search').toLowerCase();
            const outcomeData = row.getAttribute('data-outcome');
            const directionData = row.getAttribute('data-direction');
            const rowDate = parseRowDate(row);

            const matchesSearch = searchData.includes(searchTerm);
            const matchesOutcome = !outcomeValue || outcomeData === outcomeValue;
            const matchesDirection = !directionValue || directionData === directionValue;

            let matchesDate = true;
            if (matchesDate && fromDate && rowDate) {
                matchesDate = rowDate >= fromDate;
            }
            if (matchesDate && toDate && rowDate) {
                matchesDate = rowDate <= toDate;
            }

            if (matchesSearch && matchesOutcome && matchesDirection && matchesDate) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        if (paginationInfo) {
            paginationInfo.textContent = `${visibleCount} {% trans "decision(s) shown" %}`;
        }
    };

    // Event listeners for filters
    if (searchInput) {
        searchInput.addEventListener('input', filterDecisions);
    }

    if (outcomeFilter) {
        outcomeFilter.addEventListener('change', filterDecisions);
    }

    if (directionFilter) {
        directionFilter.addEventListener('change', filterDecisions);
    }

    if (fromDateInput) {
        fromDateInput.addEventListener('change', filterDecisions);
    }

    if (toDateInput) {
        toDateInput.addEventListener('change', filterDecisions);
    }

    if (dateSortSelect) {
        dateSortSelect.addEventListener('change', () => {
            sortRows();
            filterDecisions();
        });
    }

    // Refresh button
    refreshBtn.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Refreshing..." %}';
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });

    // Kill switch functionality
    if (killSwitchBtn) {
        killSwitchBtn.addEventListener('click', function() {
            const isActive = this.classList.contains('active');
            const action = isActive ? 'enable' : 'disable';
            
            if (confirm(`Are you sure you want to ${action} all trading? This will ${action} all active bots.`)) {
                // Simulate API call
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                this.disabled = true;

                setTimeout(() => {
                    if (isActive) {
                        this.classList.remove('active');
                        this.innerHTML = '<i class="fas fa-power-off"></i> {% trans "Global Kill Switch" %}';
                    } else {
                        this.classList.add('active');
                        this.innerHTML = '<i class="fas fa-check"></i> {% trans "Trading Disabled" %}';
                    }
                    this.disabled = false;
                }, 2000);
            }
        });
    }

    // Expand reason text on click
    const reasonTexts = document.querySelectorAll('.reason-text');
    reasonTexts.forEach(text => {
        text.addEventListener('click', function() {
            this.classList.toggle('expanded');
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Focus search on Ctrl+K or /
        if ((e.ctrlKey && e.key === 'k') || e.key === '/') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Refresh on F5
        if (e.key === 'F5') {
            e.preventDefault();
            refreshBtn.click();
        }
    });

    sortRows();
    filterDecisions();
});
</script>
{% endblock %}
