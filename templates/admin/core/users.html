{% extends "admin/trading_base.html" %}
{% load static i18n %}

{% block title %}{% trans "Users & Access Control" %} | EzTrade{% endblock %}

{% block page_title %}{% trans "Users & Access Control" %}{% endblock %}

{% block page_subtitle %}{% trans "Manage who can log into EzTrade, assign roles, and keep your trading infrastructure locked behind the right permissions." %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .users-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* User-specific styles */
    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .role-superuser {
        background: rgba(244, 114, 182, 0.22);
        color: #fce7f3;
    }

    .role-staff {
        background: rgba(59, 130, 246, 0.22);
        color: #dbeafe;
    }

    .role-readonly {
        background: rgba(34, 197, 94, 0.18);
        color: #bbf7d0;
    }

    .role-basic {
        background: rgba(148, 163, 184, 0.18);
        color: var(--gray-100);
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
        white-space: nowrap;
    }

    .status-active {
        background: var(--success-light);
        color: var(--success);
    }

    .status-inactive {
        background: rgba(148, 163, 184, 0.2);
        color: var(--gray-200);
    }

    .status-pending {
        background: var(--warning-light);
        color: var(--warning);
    }

    /* 2FA badges */
    .mfa-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-sm);
        padding: var(--space-xs) var(--space-md);
        border-radius: 12px;
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .mfa-enforced {
        background: rgba(34, 197, 94, 0.18);
        color: #bbf7d0;
    }

    .mfa-enabled {
        background: rgba(59, 130, 246, 0.22);
        color: #dbeafe;
    }

    .mfa-optional {
        background: rgba(148, 163, 184, 0.18);
        color: var(--gray-100);
    }

    .mfa-disabled {
        background: rgba(148, 163, 184, 0.1);
        color: var(--gray-400);
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: var(--space-xs);
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        color: var(--gray-400);
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: var(--text-sm);
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--border-medium);
        color: var(--light);
    }

    .action-btn.edit:hover {
        background: rgba(67, 97, 238, 0.2);
        color: var(--primary-light);
    }

    .action-btn.impersonate:hover {
        background: rgba(76, 201, 240, 0.2);
        color: var(--success);
    }

    .action-btn.delete:hover {
        background: rgba(247, 37, 133, 0.2);
        color: var(--danger);
    }

    /* Metrics */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .metric-card {
        background: var(--bg-card);
        backdrop-filter: var(--backdrop-blur);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        border: 1px solid var(--border-light);
        text-align: center;
        transition: all 0.3s ease;
    }

    .metric-card:hover {
        border-color: var(--border-medium);
        transform: translateY(-2px);
    }

    .metric-label {
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-400);
        margin-bottom: var(--space-xs);
        font-weight: 600;
    }

    .metric-value {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--space-xs);
        background: linear-gradient(90deg, #fff 0%, #a5b4fc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .metric-change {
        font-size: var(--text-xs);
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-xs);
    }

    .metric-change.positive {
        color: var(--success);
    }

    .metric-change.neutral {
        color: var(--gray-400);
    }

    /* Form Styles */
    .form-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-lg);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: var(--space-sm);
    }

    .form-label {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--gray-300);
    }

    .form-control {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        color: var(--light);
        font-size: var(--text-sm);
        transition: all 0.3s ease;
        width: 100%;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.08);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .form-text {
        font-size: var(--text-xs);
        color: var(--gray-400);
        line-height: 1.4;
    }

    .form-actions {
        grid-column: 1 / -1;
        display: flex;
        gap: var(--space-md);
        justify-content: flex-end;
        padding-top: var(--space-lg);
        border-top: 1px solid var(--border-light);
        margin-top: var(--space-lg);
    }

    /* User meta info */
    .user-meta {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .user-name {
        font-weight: 600;
        color: var(--light);
    }

    .user-details {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--gray-400);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: var(--space-md);
        opacity: 0.5;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .table-container {
            overflow-x: auto;
        }

        .modern-table {
            min-width: 800px;
        }
    }

    @media (max-width: 768px) {
        .form-container {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .header-actions {
            flex-direction: column;
            gap: var(--space-md);
        }

        .header-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .filters-bar {
            flex-direction: column;
        }

        .filter-actions {
            flex-direction: column;
        }

        .filter-select {
            min-width: 100%;
        }

        .action-buttons {
            flex-direction: column;
        }

        .action-btn {
            width: 28px;
            height: 28px;
        }
    }

    @media (max-width: 480px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="users-container">
    <!-- Header Actions -->
    <div class="header-actions" style="margin-bottom: var(--space-xl);">
        <a href="{% url 'admin:auth_user_add' %}" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> {% trans "Add User" %}
        </a>
        <a href="{% url 'admin:auth_user_changelist' %}" class="btn btn-outline">
            <i class="fas fa-table"></i> {% trans "Open in Admin" %}
        </a>
        <button type="button" class="btn btn-success" id="inviteUserBtn">
            <i class="fas fa-paper-plane"></i> {% trans "Invite via Email" %}
        </button>
        <button type="button" class="btn btn-outline" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> {% trans "Refresh" %}
        </button>
    </div>

    <!-- Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">{% trans "Total Users" %}</div>
            <div class="metric-value">24</div>
            <div class="metric-change positive">
                <i class="fas fa-user-friends"></i>
                {% trans "5 new this month" %}
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-label">{% trans "Active Sessions" %}</div>
            <div class="metric-value">7</div>
            <div class="metric-change neutral">
                <i class="fas fa-signal"></i>
                {% trans "Includes staff & read-only" %}
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-label">{% trans "Superusers" %}</div>
            <div class="metric-value">2</div>
            <div class="metric-change neutral">
                <i class="fas fa-lock"></i>
                {% trans "Keep this number small" %}
            </div>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" 
                   placeholder="{% trans 'Search by username, email or role...' %}" 
                   id="searchInput">
        </div>
        <div class="filter-actions">
            <select class="filter-select" id="statusFilter">
                <option value="">{% trans "All Status" %}</option>
                <option value="active">{% trans "Active" %}</option>
                <option value="inactive">{% trans "Inactive" %}</option>
                <option value="pending">{% trans "Pending" %}</option>
            </select>
            <select class="filter-select" id="roleFilter">
                <option value="">{% trans "All Roles" %}</option>
                <option value="superuser">{% trans "Superuser" %}</option>
                <option value="staff">{% trans "Staff" %}</option>
                <option value="readonly">{% trans "Read-only" %}</option>
                <option value="basic">{% trans "Basic" %}</option>
            </select>
            <select class="filter-select" id="mfaFilter">
                <option value="">{% trans "2FA Status" %}</option>
                <option value="enforced">{% trans "Enforced" %}</option>
                <option value="enabled">{% trans "Enabled" %}</option>
                <option value="optional">{% trans "Optional" %}</option>
                <option value="disabled">{% trans "Disabled" %}</option>
            </select>
            <button class="btn btn-outline" type="button" id="clearFiltersBtn">
                <i class="fas fa-times"></i> {% trans "Clear Filters" %}
            </button>
        </div>
    </div>

    <!-- Users Table Card -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "User Directory" %}</h3>
                <p class="card-subtitle">
                    {% trans "Snapshot of every account that can touch your bots, brokers, or risk controls." %}
                </p>
            </div>
            <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
                <a href="{% url 'admin:auth_group_changelist' %}" class="btn btn-outline">
                    <i class="fas fa-layer-group"></i> {% trans "Groups & Roles" %}
                </a>
            </div>
        </div>

        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>{% trans "User" %}</th>
                        <th>{% trans "Email" %}</th>
                        <th>{% trans "Role" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Last Login" %}</th>
                        <th>{% trans "Date Joined" %}</th>
                        <th>{% trans "2FA" %}</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
    {% for u in users %}
    <tr class="user-row"
        data-status="{{ u.is_active|yesno:'active,inactive' }}"
        data-role="{% if u.is_superuser %}superuser{% elif u.is_staff %}staff{% else %}basic{% endif %}"
        data-mfa="disabled"
        data-search="{{ u.username }} {{ u.email }} {% if u.is_superuser %}superuser{% elif u.is_staff %}staff{% else %}basic{% endif %}">
        <td>
            <div class="user-meta">
                <div class="user-name">{{ u.username }}</div>
                <div class="user-details">ID: {{ u.id }}</div>
            </div>
        </td>
        <td>{{ u.email|default:"-" }}</td>
        <td>
            {% if u.is_superuser %}
                <span class="role-badge role-superuser"><i class="fas fa-crown"></i> {% trans "Superuser" %}</span>
            {% elif u.is_staff %}
                <span class="role-badge role-staff"><i class="fas fa-user-gear"></i> {% trans "Staff" %}</span>
            {% else %}
                <span class="role-badge role-basic"><i class="fas fa-user"></i> {% trans "Basic" %}</span>
            {% endif %}
        </td>
        <td>
            {% if u.is_active %}
                <span class="status-badge status-active"><i class="fas fa-circle" style="font-size:0.6rem;"></i> {% trans "Active" %}</span>
            {% else %}
                <span class="status-badge status-inactive"><i class="fas fa-circle" style="font-size:0.6rem;"></i> {% trans "Inactive" %}</span>
            {% endif %}
        </td>
        <td>{% if u.last_login %}{{ u.last_login }}{% else %}{% trans "Never" %}{% endif %}</td>
        <td>{{ u.date_joined }}</td>
        <td><span class="mfa-badge mfa-disabled">{% trans "Unknown" %}</span></td>
        <td>
            <div class="action-buttons">
                <a href="{% url 'admin:auth_user_change' u.pk %}" class="action-btn edit" title="{% trans 'Edit user' %}"><i class="fas fa-edit"></i></a>
                <a href="{% url 'admin:auth_user_change' u.pk %}" class="action-btn delete" title="{% trans 'Disable user' %}"><i class="fas fa-user-slash"></i></a>
            </div>
        </td>
    </tr>
    {% empty %}
    <tr><td colspan="8" class="empty-state"><i class="fas fa-users empty-state-icon"></i><div>{% trans "No users found." %}</div></td></tr>
    {% endfor %}
</tbody>

            </table>
        </div>

        <div class="pagination">
            <div class="pagination-info">
                {% trans "Showing 1 to 4 of 24 users" %}
            </div>
            <div class="pagination-controls">
                <a href="#" class="pagination-btn">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <a href="#" class="pagination-btn active">1</a>
                <a href="#" class="pagination-btn">2</a>
                <a href="#" class="pagination-btn">3</a>
                <a href="#" class="pagination-btn">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Access Policy Card -->
    <div class="card">
        <div class="card-header">
            <div>
                <h3 class="card-title">{% trans "Access Policy" %}</h3>
                <p class="card-subtitle">
                    {% trans "Configure how your deployment should treat new users and high-risk actions." %}
                </p>
            </div>
        </div>
        
        <form class="form-container" method="post" action="#">
            <div class="form-group">
                <label class="form-label">{% trans "Default Role for New Users" %}</label>
                <select class="form-control">
                    <option>{% trans "Read-only" %}</option>
                    <option>{% trans "Basic" %}</option>
                    <option>{% trans "Staff (Ops)" %}</option>
                    <option>{% trans "Custom (via group)" %}</option>
                </select>
                <div class="form-text">
                    {% trans "Best practice is to start as read-only and manually grant higher privileges." %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">{% trans "Require 2FA for Staff & Superusers" %}</label>
                <select class="form-control">
                    <option>{% trans "Enforce for staff & superusers" %}</option>
                    <option>{% trans "Enforce for everyone" %}</option>
                    <option>{% trans "Optional (warn only)" %}</option>
                    <option>{% trans "Disabled" %}</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">{% trans "Session Timeout (minutes)" %}</label>
                <input type="number" class="form-control" placeholder="30">
                <div class="form-text">
                    {% trans "How long before idle admin sessions are forced to log in again." %}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">{% trans "Login Alert Policy" %}</label>
                <select class="form-control">
                    <option>{% trans "Email on new device / IP" %}</option>
                    <option>{% trans "Log only" %}</option>
                    <option>{% trans "Disable alerts" %}</option>
                </select>
                <div class="form-text">
                    {% trans "You can later connect this to your email / Telegram alert engine." %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="cancelPolicyBtn">
                    {% trans "Cancel" %}
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> {% trans "Save Policy" %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const roleFilter = document.getElementById('roleFilter');
    const mfaFilter = document.getElementById('mfaFilter');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const inviteUserBtn = document.getElementById('inviteUserBtn');
    const cancelPolicyBtn = document.getElementById('cancelPolicyBtn');
    const userRows = document.querySelectorAll('.user-row');

    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const roleValue = roleFilter.value;
        const mfaValue = mfaFilter.value;

        let visibleCount = 0;

        userRows.forEach(row => {
            const searchData = row.getAttribute('data-search').toLowerCase();
            const statusData = row.getAttribute('data-status');
            const roleData = row.getAttribute('data-role');
            const mfaData = row.getAttribute('data-mfa');

            const matchesSearch = searchData.includes(searchTerm);
            const matchesStatus = !statusValue || statusData === statusValue;
            const matchesRole = !roleValue || roleData === roleValue;
            const matchesMfa = !mfaValue || mfaData === mfaValue;

            if (matchesSearch && matchesStatus && matchesRole && matchesMfa) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update pagination info
        const paginationInfo = document.querySelector('.pagination-info');
        if (paginationInfo) {
            paginationInfo.textContent = `{% trans "Showing" %} 1 {% trans "to" %} ${visibleCount} {% trans "of" %} 24 {% trans "users" %}`;
        }
    }

    // Event listeners for filters
    searchInput.addEventListener('input', filterUsers);
    statusFilter.addEventListener('change', filterUsers);
    roleFilter.addEventListener('change', filterUsers);
    mfaFilter.addEventListener('change', filterUsers);

    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        searchInput.value = '';
        statusFilter.value = '';
        roleFilter.value = '';
        mfaFilter.value = '';
        filterUsers();
    });

    // Refresh button
    refreshBtn.addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Refreshing..." %}';
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });

    // Invite user button
    inviteUserBtn.addEventListener('click', function() {
        showNotification('{% trans "User invitation feature coming soon!" %}', 'info');
    });

    // Cancel policy form
    cancelPolicyBtn.addEventListener('click', function() {
        const form = this.closest('form');
        form.reset();
        showNotification('{% trans "Policy changes cancelled" %}', 'info');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Focus search on Ctrl+K or /
        if ((e.ctrlKey && e.key === 'k') || e.key === '/') {
            e.preventDefault();
            searchInput.focus();
        }
        
        // Refresh on F5
        if (e.key === 'F5') {
            e.preventDefault();
            refreshBtn.click();
        }
        
        // New user on Ctrl+N
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            document.querySelector('a[href*="auth_user_add"]').click();
        }
    });

    // Auto-refresh every 30 seconds (optional)
    setInterval(() => {
        if (!document.hidden) {
            refreshBtn.click();
        }
    }, 30000);

    // Initial filter application
    filterUsers();
});
</script>
{% endblock %}
